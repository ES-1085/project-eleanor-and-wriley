---
title: "tower count data cleaning"
author: "Eleanor and Wriley"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(viridis)
library(hrbrthemes)
library(sf)
library(leaflet)
library(lubridate)
```


##FIX THE READ EXCEL IS READING EVERY YEAR IN AS 2013

##It should be possible to turn the pivoting into a function if I can tell it to select from a list of possible columns


```{r 2000}
tower_count_2000 <- read_excel("data/tower_count/tower_count_2000.XLS")
#will have fun times trying to break up adult and juvenile eiders



```


```{r}
#tower <- rbind(tower_2006_clean, tower_2009_clean, tower_2001_clean)
#use sub string to create a new column extracting the year
```

```{r}
cleaner <- function(inputdataframe) {  
  r <- inputdataframe %>% 
    #puffins
  mutate(puffin = str_extract(other, "\\d*puff|\\d*.puff|\\d*atpu|\\d*.atpu|\\d*puffis|\\d*puffins|\\d*.puffins|\\*.ATPU|\\d*.ALPU")) %>% 
  mutate(puffin = str_extract(puffin, "\\d*")) %>%
  mutate(puffin = as.double(puffin)) %>% 
    #cormorants
  mutate(dcco = str_extract(other, "\\d*corm|\\d*dcc|\\d*dcco|\\d*ddco|\\d*.DCCO|\\d*.DCC0")) %>% 
  mutate(dcco = str_extract(dcco, "\\d*")) %>% 
  mutate(dcco = as.double(dcco)) %>% 
    #terns
  mutate(ternsp = str_extract(other, "\\d*cote|\\d*.terns|\\d*.COTE|\\d*.ARTE|\\d*.Terns|\\d*.Tern")) %>% 
  mutate(ternsp = str_extract(ternsp, "\\d*")) %>%
  mutate(ternsp = as.double(ternsp)) %>% 
    #razorbills
  mutate(razo = str_extract(other, "\\d*razo|\\d*razor|\\d*.RAZO|\\d*.razorbills")) %>% 
  mutate(razo = str_extract(razo, "\\d*")) %>% 
  mutate(razo = as.double(razo)) %>%
    #laughing gulls
  mutate(lagu = str_extract(other, "\\d*lagu|\\d*.laughing|\\d*.LAGU")) %>% 
  mutate(lagu = str_extract(lagu, "\\d*")) %>% 
  mutate(lagu = as.double(lagu)) %>% 
    #common murre
  mutate(comu = str_extract(other, "\\d*murre|\\d*.COMU|\\d*.common murre")) %>% 
  mutate(comu = str_extract(comu, "\\d*")) %>% 
  mutate(comu = as.double(comu)) %>% 
    #bald eagle
  mutate(baea = str_extract(other, "\\d*.imm|\\d*.BAEA")) %>% 
  mutate(baea = str_extract(baea, "\\d*")) %>% 
  mutate(baea = as.double(baea)) %>%
    #gannet
  mutate(noga = str_extract(other, "\\d*.gannets||\\d*.NOGA")) %>% 
  mutate(noga = str_extract(noga, "\\d*")) %>% 
  mutate(noga = as.double(noga)) %>% 
    #corvids
  mutate(corvid = str_extract(other, "\\d*.crow|\\d*.Corvid|\\d*.AMCR|\\d*.Corvids")) %>% 
  mutate(corvid = str_extract(corvid, "\\d*")) %>%
  mutate(corvid = as.double(corvid)) %>% 
    #sandpipers
  mutate(peepsp = str_extract(other, "\\d*.SPSA|\\d*.WHIM|\\d*..SPSA|\\d*.spotted sandpiper")) %>% 
  mutate(peepsp = str_extract(peepsp, "\\d*")) %>% 
  mutate(peepsp = as.double(peepsp)) %>% 
    #seals
  mutate(seals = str_extract(other, "\\d*.Seal|\\d*.Seals|\\d*.Harbor|\\d*.Gray|\\d*.seals|\\d*.grey|\\d*.seal")) %>% 
  mutate(seals = str_extract(seals, "\\d*")) %>% 
  mutate(seals = as.double(seals)) %>% 
    #Loons
  mutate(colo = str_extract(other, "\\d*.COLO|\\d*.loon")) %>% 
  mutate(colo = str_extract(colo, "\\d*")) %>% 
  mutate(colo = as.double(colo)) %>% 
    #geese
  mutate(cago = str_extract(other, "\\d*.CAGO|\\d*.goose")) %>% 
  mutate(cago = str_extract(cago, "\\d*")) %>% 
  mutate(cago = as.double(cago)) %>% 
    #porpoise
  mutate(porpoise = str_extract(other, "\\d*.Harbor|\\d*.porpoise")) %>% 
  mutate(porpoise = as.double(str_extract(porpoise, "\\d*"))) %>% 
    #raptors
  mutate(raptor = str_extract(other, "\\d*.tv")) %>% 
  mutate(raptor = str_extract(raptor, "\\d*")) %>% 
  mutate(raptor = as.double(raptor))
  return(r)
}

fixcolumns <- function(inputdataframe) {
  r <- inputdataframe %>% 
    mutate(notes = other) %>% 
    select(date, species, count, notes) %>% 
    mutate(species = case_when(species == "GBBG" ~ "gbbg",
                            species == "HERG" ~ "herg",
                            species == "gulls" ~ "herg",
                            species == "COEI" ~ "coei_ad",
                            species == "chix" ~ "coei_ju",
                            species == "BLGU" ~ "blgu",
                            species == "hegu" ~ "herg",
                            species == "bbgu" ~ "gbbg",
                            species == "puffin" ~ "atpu",
                            species == "eider" ~ "coei_ad",
                            species == "squee" ~ "blgu",
                            TRUE ~ as.character(species)))
  return(r)
}

#pivoter <- function(inputdataframe) {
 # r <- inputdataframe %>%
  #if(colnames(inputdataframe) %in% c("HERG","hegu","gulls","HEGU")))
#}

```

```{r 2001}
tower_count_2001 <- read_excel("data/tower_count/tower_count_2001.xlsx", skip = 2)
tower_count_2001 <- tower_count_2001 %>% 
  mutate(GBBG = case_when(GBBG == "-" ~ "NA",
         TRUE ~ as.character(GBBG))) %>% 
  mutate(other = notes)

tower_count_2001 <- cleaner(tower_count_2001)

tower_count_2001 <- tower_count_2001 %>% 
  mutate(herg = as.numeric(gulls), gbbg = as.numeric(GBBG), date = Date) %>% 
  pivot_longer(cols = c(herg, gbbg, COEI, chix, BLGU, puffin, dcco, ternsp, razo, lagu, comu, baea, noga, corvid, peepsp, seals, colo, cago, porpoise),
               names_to = "species",
               values_to = "count")

tower_2001_clean <- fixcolumns(tower_count_2001)
```

```{r 2002}
tower_count_2002 <- read_excel("data/tower_count/tower_count_2002.xlsx", skip = 2)
tower_count_2002 <- tower_count_2002 %>% 
  mutate(other = notes)

tower_count_2002 <- cleaner(tower_count_2002)

tower_count_2002 <- tower_count_2002 %>% 
  mutate(herg = as.numeric(HERG), gbbg = as.numeric(GBBG),coei_ad = as.numeric(COEI), coei_ju = as.numeric(chix), blgu = as.numeric(BLGU), date = Date) %>% 
  pivot_longer(cols = c (herg, gbbg, coei_ad, coei_ju, blgu, puffin, dcco, ternsp, razo, lagu, comu, baea, noga, corvid, peepsp, seals, colo, cago, porpoise),
               names_to = "species",
               values_to = "count")

tower_2002_clean <- fixcolumns(tower_count_2002)
  


```

```{r}
tower_count_2003 <- read_excel("data/tower_count/tower_count_2003.xls")

tower_count_2003 <- tower_count_2003 %>% 
  mutate(coei_ju = as.double(str_extract(Eider, "/*."))) %>% 
  mutate(coei_ad = as.double(str_extract(Eider, "d*.+/|d*.+"))) %>% 
  mutate(coei_ad = as.double(str_extract(coei_ad,"\\d*"))) %>% 
  mutate(coei_ju = as.double(str_extract(coei_ju, "\\d*"))) %>% 
  mutate(gbbg = as.double(str_extract(BBGull, "\\d*"))) %>% 
  mutate(other = Others)

tower_count_2003 <- cleaner(tower_count_2003)

tower_count_2003 <- tower_count_2003 %>% 
  mutate(herg = HerGull, blgu = Guillem, date = Date, notes = other) %>% 
  pivot_longer(cols = c(herg, gbbg, coei_ad, coei_ju, blgu, puffin, dcco, ternsp, razo, lagu, comu, baea, noga, corvid, peepsp, seals, colo, cago, porpoise),
               names_to = "species",
               values_to = "count")

tower_2003_clean <- fixcolumns(tower_count_2003)

```



```{r 2011}
tower_count_2011 <- read_excel("data/tower_count/tower_count_2011.xls", skip = 2)
tower_count_2011 <- tower_count_2011[1:47,]
tower_count_2011 <- tower_count_2011 %>% 
  mutate(year = "2011") %>% 
  mutate(day = str_sub(Date, start = 1, end = 2)) %>% 
  mutate(monthch = str_sub(Date, start = 3,)) %>% 
  mutate(month = case_when(monthch %in% "June" ~ "6",
                           monthch %in% " June" ~ "6",
                           monthch %in% " July" ~ "7",
                           monthch %in% " August" ~ "8",
                           monthch %in% "July" ~ "7",
                           monthch %in% "August" ~ "8",
                           TRUE ~ ""
                           )) %>% 
  mutate(month = as.numeric(month), day = as.numeric(day), year = as.numeric(year)) %>% 
  mutate(datereal = make_date(year, month, day)) %>% 
  select(-year, -day, -month, -monthch, -Date) %>% 
  mutate(date = datereal) %>% 
  select(-datereal)
  

tower_count_2011 <- tower_count_2011 %>% 
  mutate(other = Others)

tower_count_2011 <- cleaner(tower_count_2011)

tower_count_2011 <- tower_count_2011 %>% 
  mutate(herg = as.double(HERG), gbbg = as.double(GBBG), blgu = as.double(BLGU), coei_ad = as.double(COEI), atpu = as.double(ATPU), coei_ju = as.double(`Eider Chicks`)) %>% 
  pivot_longer(cols = c(herg, gbbg, coei_ad, coei_ju, blgu, atpu, dcco, ternsp, razo, lagu, comu, baea, noga, corvid, peepsp),
               names_to = "species",
               values_to = "count")


tower_2011_clean <- fixcolumns(tower_count_2011)
```


```{r}
tower_count_2006 <- read_excel("data/tower_count/tower_count_2006.xls")

tower_count_2006 <- cleaner(tower_count_2006)

tower_count_2006 <- tower_count_2006 %>% 
  pivot_longer(cols = c(hegu, bbgu, eider, squee, puffin, dcco, ternsp, razo, lagu, comu, baea, noga, corvid, peepsp),
             names_to = "species",
             values_to = "count")

tower_2006_clean <- fixcolumns(tower_count_2006)


```

```{r}
# Fix dates
##fixdates <- function(df, year){
 # if(length(df$Date > 1)){
#    rename(df, "Date" = "date")
#  }
  #df$month <- lubridate::month(df$date)
  #df$year <- year
 # df$day <- lubridate::day(df$date)
  
 # df$new_date <- paste0(df$year, "-", df$month, "-", df$day)
 # return(df)
#}
```

