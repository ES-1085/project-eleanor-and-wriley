---
title: "Project Work"
author: "Eleanor and Wriley"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(viridis)
library(hrbrthemes)
library(sf)
library(leaflet)
library(gganimate)
library(ggimage)
library(gifski)
library(transformr)
library(forcats)
library(visdat)
```

## R Markdown


##Island Counts over Time
```{r reading in data}
data <- read_csv("data/chickchecktidy2022.csv")
```

```{r reading in data cont}
population_distribution_gulls <- read_xlsx(str_c("data/gull_pop_distribution_2022.xlsx")) 
population_distribution_gulls$West[3]=193 
```

```{r dodged barplot}

#it would be good to split this up into a data tidying section and then the visuals
ggplot(population_distribution_gulls, aes(x = `YEAR`, y = `Total Corrected`)) +
  geom_col()

head(population_distribution_gulls)

population_distribution_gulls$West[3]=193

population_distribution_gulls %>%
  rename(little_point = `Little Point (near Boathouse)`) %>%
  mutate(West = as.numeric(`West`)) %>%
  mutate(south_end = East + West + Extension) %>%
  mutate(north_end = Point + Cabin + Hell) %>%
  select(YEAR, south_end, north_end, Borofsky, little_point) %>%
  pivot_longer( cols = south_end:little_point,
               names_to = "location",
               values_to = "total") %>%
  ggplot(aes(y = total, x = YEAR, fill = location)) +
  geom_col(position = "dodge", stat = "identity") +
   scale_fill_viridis(discrete = T) +
  theme_ipsum()

population_distribution_gulls %>%
  rename(little_point = `Little Point (near Boathouse)`) %>%
  mutate(West = as.numeric(`West`)) %>%
  select(YEAR, East, West, Extension) %>%
  pivot_longer( cols = East:Extension,
               names_to = "location",
               values_to = "total") %>%
  ggplot(aes(y = total, x = YEAR, fill = location)) +
  geom_col(position = "dodge", stat = "identity") +
   scale_fill_viridis(discrete = T) +
  theme_ipsum()
```

```{r filled barplot}
population_distribution_gulls %>%
  rename(little_point = `Little Point (near Boathouse)`) %>%
  mutate(West = as.numeric(`West`)) %>%
  mutate(south_end = East + West + Extension) %>%
  mutate(north_end = Point + Cabin + Hell) %>%
  filter(!is.na(south_end)) %>% 
  select(YEAR, south_end, north_end, Borofsky, little_point) %>%
  pivot_longer( cols = south_end:little_point,
               names_to = "location",
               values_to = "total") %>%
  ggplot(aes(y = total, x = YEAR, fill = location)) +
  geom_col(position = "fill", stat = "identity") +
   scale_fill_viridis(discrete = T) +
  theme_ipsum()
```

##Tower Count Visualization (Eleanor)

see shiny app for others

```{r barplot animation}

tower <- read_csv("data/towerclean.csv")
tower %>%
  filter(!is.na(count)) %>% 
  filter(species == c("herg","coei_ju","coei_ad","gbbg","blgu","puffin")) %>%
  group_by(species, year) %>% 
  summarize(max = max(count)) %>%
  ggplot(aes(x = species, y = max, fill = species))+
  geom_col()+
  transition_states(states = year, 
                    transition_length = 2,
                    state_length = 1)+
    labs(title = 'Year: {frame_time}', 
       x = 'max count', 
       y = 'species')
```

```{r visualize-missing-data}
visdat::vis_miss(tower)
visdat::vis_miss(nest_count_clean_2022)

```


##Colony Distribution Animation

```{r practice leaflet}

gullshape2021 <- read_sf("data/gullshapefiles/gulls2021")
outline <- read_sf("data/outlinecolored")
head(gullshape2021)
plot(gullshape2021)

gullshape2021 <- st_transform(gullshape2021, "+init=epsg:4326")
outline <- st_transform(outline, "+init=epsg:4326")

leaflet(data = gullshape2021) %>% 
  addProviderTiles(providers$Esri.WorldImagery) %>% 
    setView(lng = -68, 
          lat = 44, 
          zoom = 8) %>%
  addPolygons(data = outline) %>% 
  addCircleMarkers()

```


```{r join-shapefile-nestcount}
##2022
gullshape2022 <- read_sf("data/gullshapefiles/Gulls2022")
nest_count_clean_2022 <- read.csv("data/nest_count_clean/nest_count_clean_2022.csv")
gullshape2022 <- st_transform(gullshape2022, "+init=epsg:4326") %>%
  select(Comment, geometry) %>%
  rename(flag = "Comment") %>%
  mutate(flag = as.integer(flag))

gullshape2022 <- gullshape2022 %>%
  full_join(nest_count_clean_2022, by = "flag") %>%
  mutate(year = "2022") %>%
  select(flag, geometry, clutch, year, species)
##2021
gullshape2021 <- read_sf("data/gullshapefiles/Gulls2021")
nest_count_clean_2021 <- read.csv("data/nest_count_clean/nest_count_clean_2021.csv")
gullshape2021 <- st_transform(gullshape2021, "+init=epsg:4326") %>%
  select(Comment, geometry) %>%
  rename(flag = "Comment") %>%
  mutate(flag = as.integer(flag))

gullshape2021 <- gullshape2021 %>%
  full_join(nest_count_clean_2022, by = "flag") %>%
  mutate(year = "2021") %>%
  select(flag, geometry, clutch, year, species)



gullshapetest <- rbind(gullshape2022, gullshape2021)


```

```{r map-just-colony, eval = FALSE, echo = TRUE, fig.height=4, fig.width=4}
ggplot(outline) +
  # geom_sf(data = outline, fill = "lightblue")+
  geom_sf(data = gullshapetest, color = "midnightblue", aes(group = year)) +
  coord_sf(ylim = c(44.140385, 44.145726), xlim = c(-68.25038, -68.242629), expand = FALSE) + 
  transition_states(states = year) +
  #  # ease_aes('linear') +
  theme_bw()

```


<<<<<<< HEAD
towerclean %>%  
  group_by(species) %>% 
  summarize(max = max(count)) %>%
  filter(max >= 5) %>%
  ggplot(aes(y = species, x = max, fill = species))+
  geom_col()+
  scale_fill_viridis_d()+
  labs(main = "Species High Counts")
  

```{r loading tracking data}

gulltrack <- sometrackingdata <- read_delim("data/sometrackingdata.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)


GUL01 <- gulltrack %>% 
  filter(`Logger ID` == "GUL01")
 
ggplot()+
  geom_path(data = GUL01, aes(x = Longitude, y = Latitude))
```

```{r gull colony size vs gull tower counts}

pop_dist_clean <- population_distribution_gulls %>%
  rename(little_point = `Little Point (near Boathouse)`) %>%
  mutate(West = as.numeric(`West`)) %>%
  mutate(south_end = East + West + Extension) %>%
  mutate(north_end = Point + Cabin + Hell) %>%
  select(YEAR, south_end, north_end, Borofsky, little_point) %>%
  pivot_longer( cols = south_end:little_point,
               names_to = "location",
               values_to = "total") %>% 
  filter(location == "south_end") %>% 
  mutate(year = as.character(YEAR))

towerclean %>%
  mutate(year = as.character(year)) %>% 
  filter(species == "herg") %>% 
  group_by(year) %>% 
  mutate(year = as.character(year)) %>% 
  ggplot()+
  geom_boxplot(aes(x = year, y = count))+
  geom_point(data = pop_dist_clean, aes(x = year, y = total), color = "aquamarine4")
```


```{r contains code to make error bars}
se <- function(x) sd(x)/sqrt(length(x))
towerclean %>% 
  filter(species == c("herg","gbbg","blgu")) %>%
  filter(year == 2022) %>% 
  group_by(species, year) %>% 
  summarize(mean = mean(count), se = se(count)) %>% 
  ggplot(aes(x = species, y = mean, fill = species))+
  geom_col()+
  geom_errorbar(aes(x = species, ymin = (mean - se), ymax = (mean + se)), size = 1, width = 0.3, alpha = 0.5)
  
```

```{r}
gulls2000 <- towerclean %>% 
  filter(species == "herg", year == 2000)

gulls2022 <- towerclean %>% 
  filter(species == "herg", year == 2022)

boxplot(gulls2022$count, gulls2000$count)


t <- t.test(gulls2000$count, gulls2022$count)
t

```

```{r}

blgus2000 <- towerclean %>% 
  filter(species == "blgu", year == 2000)

blgus2022 <- towerclean %>% 
  filter(species == "blgu", year == 2022)


t <- t.test(blgus2000$count, blgus2022$count)
t

```

<<<<<<< HEAD
=======
```{r}
towerclean %>% 
  filter(year == 2022) %>%
  filter(species == "herg") %>% 
  ggplot(aes(x = date, y = count, fill = species)) + 
  geom_col()+
  facet_wrap(~species)
```

```{r}

palvoy <- park_palette("Voyageurs", 4)

se <- function(x) sd(x)/sqrt(length(x))

plot1 <- towerclean %>%
  filter(species == c("herg","gbbg","blgu","coei_ad")) %>% 
  mutate(label = case_when(species == "herg" ~ "Herring Gull",
                          species == "gbbg" ~ "Great Black-backed Gull",
                          species == "blgu" ~ "Black Guillemot",
                          species == "coei_ad" ~ "Common Eider",
                          TRUE ~ as.character(species))) %>%
  group_by(species, label, year) %>% 
  mutate(med = median(count), se = se(count)) %>% 
  ggplot()+
  geom_point(aes(x = year, y = med, color = label), size = 1.3)+
  geom_errorbar(aes(x = year, ymin = (med - se), ymax = (med + se), color = label), alpha = 1, size = 0.5, width = 0.003)+
  geom_line(aes(x = year, y = med, color = label), linewidth = 1)+
  scale_color_viridis_d(direction = -1) +
  #scale_color_manual(values = c("tomato3","burlywood4","mediumorchid3","lightslategrey"))+
  theme_bw()+
  facet_wrap(~species, scales = "free")+
  labs(title = "Median Counts of Species Breeding on Great Duck Island by Year", subtitle = "Error Bars Represent Standard Error", color = "Species")+
  ylab("Median Daily Count")+
  xlab("Year")

```
```{r}
plot1
plot2 <- plot1 + theme(legend.title = element_text(size = 8), 
               legend.text = element_text(size = 8), title = element_text(size = 8), legend.position = "bottom")
plot2

ggsave("plot2.png",plot2, bg = "transparent", width = 12, height = 8 )
```

```{r}

population_distribution_gulls$West[3]=193

plot3 <- population_distribution_gulls %>%
  rename(little_point = `Little Point (near Boathouse)`) %>%
  mutate(West = as.numeric(`West`)) %>%
  mutate(`South Colony` = East + West + Extension) %>%
  mutate(`North Colony` = Point + Cabin + Hell) %>%
  mutate(`Northeast Colony` = Borofsky) %>% 
  select(YEAR, `South Colony`, `North Colony`, `Northeast Colony`) %>%
  filter(!is.na(`South Colony`)) %>% 
  pivot_longer( cols = `South Colony`:`Northeast Colony`,
               names_to = "location",
               values_to = "total") %>%
  ggplot(aes(y = total, x = YEAR, fill = location)) +
  geom_col() +
  scale_fill_viridis_d(direction = -1) +
  theme_bw()+
  labs(title = "Distribution of Gull Nests across Sub-Colonies", subtitle = "by Year", fill = "Sub-Colony")+
  ylab("# of Gull Nests")+
  xlab("year")

plot3

plot3 <- plot3 + theme(legend.title = element_text(size = 8), 
               legend.text = element_text(size = 8), title = element_text(size = 9),
               legend.position = "bottom", plot.background = element_rect(fill = "#E1DAF6"))

plot3

ggsave("plot3.png", plot3, bg = "transparent", width = 8, height = 6)

```
>>>>>>> e96468c442542fdaeb10f72079d7dad291863d85

```{r}

hergs <- tower %>% 
  filter(species == "herg") %>% 
  group_by(year) %>% 
  summarize(med = median(count))

lm1 <- lm(med ~ year, data = hergs)

summary(lm1)

blgus <- tower %>% 
  filter(species == "blgu") %>% 
  group_by(year) %>%
  summarize(med = median(count))

lm2 <- lm(med ~ year, data = blgus)

summary(lm2)
```

```{r}
ggplot(hergs, aes(x = year, y = med))+
  geom_point()+
  geom_smooth(method = lm)
```

